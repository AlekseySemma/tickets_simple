<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Редактирование заявки</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4" style="max-width: 900px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">Редактирование заявки #{{ t.id }}</h3>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="/web">Назад</a>
        <a class="btn btn-outline-danger" href="/web/logout">Выйти</a>
      </div>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="card shadow-sm">
      <div class="card-body">
        <form method="post" action="/web/tickets/{{ t.id }}/edit" class="row g-3">
          <input type="hidden" name="next" value="{{ next_url }}">
          {% if can_edit_full %}
            <div class="col-12 col-md-6">
              <label class="form-label">Название</label>
              <input name="title" class="form-control" value="{{ t.title }}" required />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Проект</label>
              <select name="project_id" class="form-select" required>
                {% for p in projects %}
                  <option value="{{ p.id }}" {% if p.id == t.project_id %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}

          <div class="col-12">
            <label class="form-label">Описание</label>
            <textarea name="description" class="form-control" rows="4">{{ t.description or "" }}</textarea>
          </div>

          <div class="col-12 col-md-6">
  <label class="form-label">Срок: дата</label>
  <input id="deadline_date" name="deadline_date" type="date" class="form-control"
         value="{% if t.deadline %}{{ t.deadline.strftime('%Y-%m-%d') }}{% endif %}" />
</div>

<div class="col-12 col-md-6">
  <label class="form-label">Время (HHMM)</label>
  <div class="input-group">
    <input id="deadline_time4" name="deadline_time4" class="form-control"
           inputmode="numeric" maxlength="4"
           value="{% if t.deadline %}{{ t.deadline.strftime('%H%M') }}{% endif %}"
           placeholder="например 9, 930, 1745" />
    <span class="input-group-text" id="deadline_time_pretty">--:--</span>
  </div>
</div>


          {% if can_edit_full %}
            <div class="col-12 col-md-6">
              <label class="form-label">Исполнитель</label>
              <select name="executor_id" class="form-select">
                <option value="">— не назначен —</option>
                {% for e in executors %}
                  <option value="{{ e.id }}" {% if t.executor_id == e.id %}selected{% endif %}>{{ e.name }} ({{ e.email }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Статус</label>
              <select name="status" class="form-select">
  <option value="NEW" {% if t.status.value == "NEW" %}selected{% endif %}>Новая</option>
  <option value="IN_PROGRESS" {% if t.status.value == "IN_PROGRESS" %}selected{% endif %}>В работе</option>
  <option value="DONE" {% if t.status.value == "DONE" %}selected{% endif %}>Выполнена</option>
  <option value="CANCELED" {% if t.status.value == "CANCELED" %}selected{% endif %}>Отменена</option>
</select>
            </div>
          {% endif %}
            
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Сохранить</button>
            <a class="btn btn-outline-secondary" href="{{ next_url }}">Отмена</a>
          </div>

        </form>
      </div>
    </div>
  </div>

<script>
  (function () {
    const dateEl = document.getElementById("deadline_date");
    const timeEl = document.getElementById("deadline_time4");
    const prettyEl = document.getElementById("deadline_time_pretty");
    if (!dateEl || !timeEl || !prettyEl) return;

    const pad2 = (n) => String(n).padStart(2, "0");

    // проставим текущие значения из ticket (пришли из backend)
    const initialDate = "{{ deadline_date or '' }}";
    const initialTime = "{{ deadline_time4 or '' }}";

    if (initialDate) dateEl.value = initialDate;
    if (initialTime) timeEl.value = initialTime;

    function parseTime(value) {
      const digits = (value || "").replace(/\D/g, "").slice(0, 4);
      if (!digits) return null;

      let hh = 0, mm = 0;
      if (digits.length <= 2) {
        hh = parseInt(digits, 10);
        mm = 0;
      } else {
        const padded = digits.padStart(4, "0");
        hh = parseInt(padded.slice(0, 2), 10);
        mm = parseInt(padded.slice(2, 4), 10);
      }
      hh = Math.min(23, hh || 0);
      mm = Math.min(59, mm || 0);
      return { hh, mm };
    }

    function render() {
      const parsed = parseTime(timeEl.value);
      if (!parsed) { prettyEl.textContent = "--:--"; return; }
      prettyEl.textContent = `${pad2(parsed.hh)}:${pad2(parsed.mm)}`;
    }

    timeEl.addEventListener("input", () => {
      timeEl.value = (timeEl.value || "").replace(/\D/g, "").slice(0, 4);
      render();
    });

    timeEl.addEventListener("blur", () => {
      const parsed = parseTime(timeEl.value);
      if (!parsed) return;
      timeEl.value = `${pad2(parsed.hh)}${pad2(parsed.mm)}`;
      render();
    });

    render();
  })();
</script>
</body>
</html>
