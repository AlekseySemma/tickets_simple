<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–ó–∞—è–≤–∫–∞ #{{ t.id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .muted { color: #6c757d; }
    .badge-status { font-weight: 600; padding: .45rem .6rem; user-select: none; }
    .st-NEW { background: #6c757d !important; }
    .st-IN_PROGRESS { background: #0d6efd !important; }
    .st-DONE { background: #198754 !important; }
    .st-CANCELED { background: #212529 !important; }
    .st-OVERDUE { background: #dc3545 !important; }

    .ticket.overdue { border-color: #dc3545 !important; }

    .status-menu {
      position: absolute;
      top: 110%;
      right: 0;
      min-width: 170px;
      z-index: 10;
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
    }
    .status-menu.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .status-toggle { cursor: pointer; }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4" style="max-width: 1000px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">–ó–∞—è–≤–∫–∞ #{{ t.id }}</h3>
        <div class="muted">–ü—Ä–æ–µ–∫—Ç: <b>{{ projects_by_id.get(t.project_id, "‚Äî") }}</b></div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="/web">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        <a class="btn btn-outline-danger" href="/web/logout">–í—ã–π—Ç–∏</a>
      </div>
    </div>

    <div id="ticket-{{ t.id }}" class="card shadow-sm ticket {% if is_overdue %}overdue{% endif %}">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div style="flex:1">
            <h5 class="mb-1">{{ t.title }}</h5>
            <div class="muted mb-2">{{ t.description or "" }}</div>

            <div class="muted small">
                –ü—Ä–æ–µ–∫—Ç: <b>{{ projects_by_id.get(t.project_id, "‚Äî") }}</b>
              –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: <b>{{ users_by_id.get(t.executor_id, "‚Äî") }}</b> ¬∑
              –°–æ–∑–¥–∞–ª: <b>{{ users_by_id.get(t.created_by, "‚Äî") }}</b> ¬∑
              –°—Ä–æ–∫:
              <b>
                {% if t.deadline %}
                  {{ t.deadline.strftime("%d.%m.%Y %H:%M") }}
                {% else %}
                  ‚Äî
                {% endif %}
              </b>
            </div>
          </div>

          <div class="text-end" style="min-width: 280px;">
            <div class="d-flex justify-content-end gap-2 align-items-center">
              <div class="position-relative d-inline-block">
                <span id="status-badge-{{ t.id }}"
                      class="badge badge-status st-{{ t.status.value }} status-toggle"
                      data-ticket-id="{{ t.id }}">
                  {{ status_labels[t.status.value] }} ‚ñº
                </span>

                <div id="status-menu-{{ t.id }}" class="status-menu shadow-sm p-2 bg-white rounded">
                  <button type="button" class="badge badge-status st-NEW w-100 mb-1 border-0 status-option"
                          data-ticket-id="{{ t.id }}" data-status="NEW">–ù–æ–≤–∞—è</button>
                  <button type="button" class="badge badge-status st-IN_PROGRESS w-100 mb-1 border-0 status-option"
                          data-ticket-id="{{ t.id }}" data-status="IN_PROGRESS">–í —Ä–∞–±–æ—Ç–µ</button>
                  <button type="button" class="badge badge-status st-DONE w-100 mb-1 border-0 status-option"
                          data-ticket-id="{{ t.id }}" data-status="DONE">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</button>
                  <button type="button" class="badge badge-status st-CANCELED w-100 border-0 status-option"
                          data-ticket-id="{{ t.id }}" data-status="CANCELED">–û—Ç–º–µ–Ω–µ–Ω–∞</button>
                </div>
              </div>

              <span id="overdue-badge-{{ t.id }}"
                    class="badge badge-status st-OVERDUE {% if not is_overdue %}d-none{% endif %}">
                –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
              </span>
            </div>

            {% if user.role == "CURATOR" or (user.role == "EXECUTOR" and (t.executor_id == user.id or t.created_by == user.id)) %}
              <a class="btn btn-sm btn-outline-secondary w-100 mt-2" href="/web/tickets/{{ t.id }}/edit">–ò–∑–º–µ–Ω–∏—Ç—å</a>
            {% endif %}

            {% if user.role == "CURATOR" or (user.role == "EXECUTOR" and t.created_by == user.id) %}
              <form method="post" action="/web/tickets/{{ t.id }}/delete" class="mt-2"
                    onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É #{{ t.id }}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');">
                <button class="btn btn-sm btn-outline-danger w-100">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            {% endif %}
          </div>
        </div>

        <hr class="my-4"/>

        <div class="row g-4">
          <div class="col-12 col-lg-7">
            <h5>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h5>

            <div class="mb-2">
              {% for c in comments %}
                <div class="border rounded p-2 mb-2">
                  <div class="small muted">
                    <b>{{ users_by_id.get(c.author_id, "‚Äî") }}</b> ¬∑ {{ c.created_at }}
                  </div>
                  <div>{{ c.text }}</div>
                </div>
              {% endfor %}
              {% if comments|length == 0 %}
                <div class="muted small">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
              {% endif %}
            </div>

            <form method="post" action="/web/tickets/{{ t.id }}/comments" class="d-flex gap-2">
              <input name="text" class="form-control" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required />
              <button class="btn btn-outline-secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
          </div>

          <div class="col-12 col-lg-5">
            <h5>–§–∞–π–ª—ã</h5>

            <div class="mb-2">
  {% for a in attachments %}
    {% set p = a.file_path or "" %}
    {% set lower = p|lower %}
    {% set is_img = lower.endswith(".png") or lower.endswith(".jpg") or lower.endswith(".jpeg") or lower.endswith(".gif") or lower.endswith(".webp") %}

    <div class="border rounded p-2 mb-2 bg-white">
      <div class="small mb-2">
  üìé <a href="{{ p }}" target="_blank">{{ p }}</a>
  <span class="muted">¬∑ –∑–∞–≥—Ä—É–∑–∏–ª: {{ users_by_id.get(a.uploader_id, "‚Äî") }}</span>
</div>


      {% if is_img %}
        <a href="{{ p }}" target="_blank">
          <img src="{{ p }}" class="img-fluid rounded" style="max-height: 260px;" />
        </a>
      {% endif %}
    </div>
  {% endfor %}

  {% if attachments|length == 0 %}
    <div class="muted small">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</div>
  {% endif %}

  
</div>


            <form method="post" action="/web/tickets/{{ t.id }}/attachments" enctype="multipart/form-data" class="d-flex gap-2">
              <input type="file" name="file" class="form-control" required />
              <button class="btn btn-outline-secondary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const STATUS_LABELS = { NEW:"–ù–æ–≤–∞—è", IN_PROGRESS:"–í —Ä–∞–±–æ—Ç–µ", DONE:"–í—ã–ø–æ–ª–Ω–µ–Ω–∞", CANCELED:"–û—Ç–º–µ–Ω–µ–Ω–∞" };

  function closeAllMenus(exceptId) {
    document.querySelectorAll(".status-menu").forEach(m => {
      if (!exceptId || m.id !== exceptId) m.classList.remove("show");
    });
  }

  document.querySelectorAll(".status-toggle").forEach(function (el) {
    el.addEventListener("click", function (event) {
      event.stopPropagation();
      const ticketId = el.dataset.ticketId;
      const menuId = "status-menu-" + ticketId;
      const menu = document.getElementById(menuId);
      if (!menu) return;
      closeAllMenus(menuId);
      menu.classList.toggle("show");
    });
  });

  document.querySelectorAll(".status-menu").forEach(menu => {
    menu.addEventListener("click", e => e.stopPropagation());
  });

  document.addEventListener("click", function () { closeAllMenus(null); });

  async function setStatus(ticketId, status) {
    const fd = new FormData();
    fd.append("status", status);

    const res = await fetch(`/web/tickets/${ticketId}/status`, {
      method: "POST",
      body: fd,
      headers: { "Accept": "application/json" },
      credentials: "same-origin"
    });

    if (!res.ok) {
      alert("–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞");
      return;
    }

    const data = await res.json();
    if (!data.ok) return;

    const badge = document.getElementById("status-badge-" + ticketId);
    if (badge) {
      badge.className = badge.className.replace(/\bst-[A-Z_]+\b/g, "").trim();
      badge.classList.add("st-" + data.status);
      badge.textContent = (STATUS_LABELS[data.status] || data.status) + " ‚ñº";
    }

    const overdueBadge = document.getElementById("overdue-badge-" + ticketId);
    const ticketEl = document.getElementById("ticket-" + ticketId);

    if (overdueBadge) {
      if (data.is_overdue) overdueBadge.classList.remove("d-none");
      else overdueBadge.classList.add("d-none");
    }
    if (ticketEl) {
      if (data.is_overdue) ticketEl.classList.add("overdue");
      else ticketEl.classList.remove("overdue");
    }

    closeAllMenus(null);
  }

  document.querySelectorAll(".status-option").forEach(btn => {
    btn.addEventListener("click", function (event) {
      event.stopPropagation();
      setStatus(btn.dataset.ticketId, btn.dataset.status);
    });
  });
});
</script>

</body>
</html>
