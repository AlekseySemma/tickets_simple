<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–ó–∞—è–≤–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .muted { color: #6c757d; }
    .ticket { border: 1px solid #e9ecef; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: #fff; }
    .ticket h5 { margin: 0 0 8px 0; }
    .badge-status { font-size: 12px; }
    .ticket.overdue { border-color: #dc3545; }
    .ticket.overdue .badge-status { background: #dc3545 !important; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-0">–ó–∞—è–≤–∫–∏</h3>
        <div class="muted">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <b>{{ user.name }}</b> ({{ user.role }})</div>
      </div>
      <div class="d-flex gap-2">
  {% if user.role == "CURATOR" %}
    <a class="btn btn-outline-secondary" href="/web/projects">–ü—Ä–æ–µ–∫—Ç—ã</a>
    <a class="btn btn-outline-secondary" href="/web/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
  {% endif %}
  <a class="btn btn-outline-secondary" href="/docs" target="_blank">Swagger</a>
  <a class="btn btn-outline-danger" href="/web/logout">–í—ã–π—Ç–∏</a>
</div>
    </div>
    <div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" action="/web" class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <label class="form-label mb-1">–ü–æ–∏—Å–∫</label>
        <input name="q" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ..." value="{{ q }}" />
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label mb-1">–°—Ç–∞—Ç—É—Å</label>
        <select name="status_filter" class="form-select">
          <option value="" {% if not status_filter %}selected{% endif %}>–í—Å–µ</option>
          <option value="NEW" {% if status_filter == "NEW" %}selected{% endif %}>NEW</option>
          <option value="IN_PROGRESS" {% if status_filter == "IN_PROGRESS" %}selected{% endif %}>IN_PROGRESS</option>
          <option value="DONE" {% if status_filter == "DONE" %}selected{% endif %}>DONE</option>
          <option value="CANCELED" {% if status_filter == "CANCELED" %}selected{% endif %}>CANCELED</option>
        </select>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label mb-1">–ü—Ä–æ–µ–∫—Ç</label>
        <select name="project_id" class="form-select">
          <option value="" {% if not project_id_filter %}selected{% endif %}>–í—Å–µ</option>
          {% for p in projects %}
            <option value="{{ p.id }}" {% if project_id_filter == p.id %}selected{% endif %}>{{ p.name }}</option>

          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-2 d-flex gap-2">
        <button class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      {% if user.role == "CURATOR" %}
  <div class="col-6 col-md-3">
    <label class="form-label mb-1">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
    <select name="executor_id" class="form-select">
  <option value="" {% if not executor_id_filter %}selected{% endif %}>–í—Å–µ</option>
  <option value="__none__" {% if executor_id_filter == "__none__" %}selected{% endif %}>‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ ‚Äî</option>
  {% for e in executors %}
    <option value="{{ e.id }}" {% if executor_id_filter == e.id %}selected{% endif %}>
      {{ e.name }}
    </option>
  {% endfor %}
</select>

  </div>

  <div class="col-12 col-md-3">
  <div class="form-check mt-4">
    <input class="form-check-input" type="checkbox" id="only_overdue" name="only_overdue" value="1"
           {% if only_overdue == "1" %}checked{% endif %}>
    <label class="form-check-label" for="only_overdue">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</label>
  </div>
</div>


  
{% endif %}


      <div class="col-12">
        <div class="col-6 col-md-3">
  <label class="form-label mb-1">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
  <select name="sort" class="form-select">
    <option value="id_desc" {% if sort == "id_desc" %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
    <option value="id_asc" {% if sort == "id_asc" %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
    <option value="deadline_asc" {% if sort == "deadline_asc" %}selected{% endif %}>–°—Ä–æ–∫: –±–ª–∏–∂–∞–π—à–∏–µ</option>
    <option value="deadline_desc" {% if sort == "deadline_desc" %}selected{% endif %}>–°—Ä–æ–∫: –¥–∞–ª—å–Ω–∏–µ</option>
    <option value="status" {% if sort == "status" %}selected{% endif %}>–ü–æ —Å—Ç–∞—Ç—É—Å—É</option>
  </select>
</div>

        <a class="small" href="/web">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
      </div>
    </form>
  </div>
</div>


    {% if user.role == "CURATOR", "EXECUTOR" %}
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="mb-3">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h5>
        <form method="post" action="/web/tickets/create" class="row g-2">
          <div class="col-12 col-md-6">
            <input name="title" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
          </div>
          <div class="col-12 col-md-6">
            <select name="project_id" class="form-select" required>
              <option value="" selected disabled>–ü—Ä–æ–µ–∫—Ç</option>
              {% for p in projects %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12">
            <textarea name="description" class="form-control" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
          </div>
          <div class="col-12 col-md-6">
            <div class="row g-2">
  <div class="row g-2">
  <div class="col-12 col-md-6">
    <label class="form-label mb-1">–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫: –¥–∞—Ç–∞</label>
    <input id="deadline_date" name="deadline_date" type="date" class="form-control" />
  </div>

  <div class="col-12 col-md-6">
    <label class="form-label mb-1">–í—Ä–µ–º—è (–≤–≤–µ–¥–∏—Ç–µ 4 —Ü–∏—Ñ—Ä—ã, HHMM)</label>
    <div class="input-group">
      <input id="deadline_time4" name="deadline_time4" class="form-control" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 0930 –∏–ª–∏ 1745" maxlength="4" />
      <span class="input-group-text" id="deadline_time_pretty">--:--</span>
    </div>
    <div class="muted small mt-1">
      –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å 1‚Äì4 —Ü–∏—Ñ—Ä—ã: <code>9</code> ‚Üí <code>09:00</code>, <code>930</code> ‚Üí <code>09:30</code>. –ü—É—Å—Ç–æ ‚Äî —Å—Ä–æ–∫ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
    </div>
  </div>
</div>



  <div class="col-12 muted small">
    –ï—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å ‚Äî —Å—Ä–æ–∫ –Ω–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
  </div>
</div>

          </div>
          <div class="col-12 col-md-6">
            {% if user.role == "CURATOR" %}
  <select name="executor_id" class="form-select">
    <option value="" selected>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
    {% for e in executors %}
      <option value="{{ e.id }}">{{ e.name }} ({{ e.email }})</option>
    {% endfor %}
  </select>
{% else %}
  <input type="hidden" name="executor_id" value="" />
  <div class="form-control bg-light">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: –≤—ã —Å–∞–º–∏</div>
{% endif %}

          </div>
          <div class="col-12">
            <button class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
          </div>
        </form>

        <div class="mt-2 muted small">
          –ß—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤/–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –±—ã–ª –Ω–µ –ø—É—Å—Ç—ã–º ‚Äî —Å–æ–∑–¥–∞–π –ø—Ä–æ–µ–∫—Ç –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–º–æ–∂–Ω–æ –≤ Swagger).
        </div>
      </div>
    </div>
    {% endif %}

    {% for t in tickets %}
      <div class="ticket shadow-sm {% if t.deadline and t.status != 'DONE' and t.status != 'CANCELED' and t.deadline < now %}overdue{% endif %}">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div style="flex:1">
            <h5>#{{ t.id }} ‚Äî {{ t.title }}</h5>
            <div class="muted">{{ t.description or "" }}</div>
            <div class="mt-2 muted small">
              –ü—Ä–æ–µ–∫—Ç: <b>{{ projects_by_id.get(t.project_id, "‚Äî") }}</b> ¬∑
              –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: <b>{{ users_by_id.get(t.executor_id, "‚Äî") }}</b> ¬∑
              –°—Ä–æ–∫: <b>{{ t.deadline or "‚Äî" }}</b> ¬∑
              –°–æ–∑–¥–∞–ª: <b>{{ users_by_id.get(t.created_by, "‚Äî") }}</b>
            </div>
          </div>

          <div class="text-end">
            <div class="mb-2">
              <span class="badge text-bg-secondary badge-status">{{ t.status }}</span>
            </div>

            <form method="post" action="/web/tickets/{{ t.id }}/status" class="d-flex gap-2">
              <select name="status" class="form-select form-select-sm" style="max-width: 190px">
                <option value="NEW" {% if t.status == "NEW" %}selected{% endif %}>NEW</option>
                <option value="IN_PROGRESS" {% if t.status == "IN_PROGRESS" %}selected{% endif %}>IN_PROGRESS</option>
                <option value="DONE" {% if t.status == "DONE" %}selected{% endif %}>DONE</option>
                <option value="CANCELED" {% if t.status == "CANCELED" %}selected{% endif %}>CANCELED</option>
              </select>
              <button class="btn btn-sm btn-outline-primary">OK</button>
            </form>
            {% if user.role == "CURATOR" or (user.role == "EXECUTOR" and (t.executor_id == user.id or t.created_by == user.id)) %}
  <a class="btn btn-sm btn-outline-secondary w-100 mt-2" href="/web/tickets/{{ t.id }}/edit">–ò–∑–º–µ–Ω–∏—Ç—å</a>
{% endif %}

            {% if user.role == "CURATOR" or (user.role == "EXECUTOR" and t.created_by == user.id) %}
            <form method="post" action="/web/tickets/{{ t.id }}/delete" class="mt-2"
              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É #{{ t.id }}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');">
            <button class="btn btn-sm btn-outline-danger w-100">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
            {% endif %}

          </div>
        </div>

        <hr />

        <div class="row g-3">
          <div class="col-12 col-lg-7">
            <h6>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h6>
            <div class="mb-2">
              {% for c in comments_by_ticket.get(t.id, []) %}
                <div class="border rounded p-2 mb-2">
                  <div class="small muted">
                    <b>{{ users_by_id.get(c.author_id, "‚Äî") }}</b> ¬∑ {{ c.created_at }}
                  </div>
                  <div>{{ c.text }}</div>
                </div>
              {% endfor %}
              {% if comments_by_ticket.get(t.id, [])|length == 0 %}
                <div class="muted small">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
              {% endif %}
            </div>

            <form method="post" action="/web/tickets/{{ t.id }}/comments" class="d-flex gap-2">
              <input name="text" class="form-control" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required />
              <button class="btn btn-outline-secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
          </div>

          <div class="col-12 col-lg-5">
            <h6>–§–∞–π–ª—ã</h6>
            <div class="mb-2">
              {% for a in attachments_by_ticket.get(t.id, []) %}
                <div class="small">
                  üìé {{ a.file_path }}
                </div>
              {% endfor %}
              {% if attachments_by_ticket.get(t.id, [])|length == 0 %}
                <div class="muted small">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</div>
              {% endif %}
            </div>

            <form method="post" action="/web/tickets/{{ t.id }}/attachments" enctype="multipart/form-data" class="d-flex gap-2">
              <input type="file" name="file" class="form-control" required />
              <button class="btn btn-outline-secondary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}

    {% if tickets|length == 0 %}
      <div class="alert alert-info">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
    {% endif %}
  </div>

<script>
  (function () {
    const el = document.getElementById("deadline_dt");
    if (!el || el.value) return;

    const d = new Date();
    const pad2 = (n) => String(n).padStart(2, "0");

    // datetime-local –æ–∂–∏–¥–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç: YYYY-MM-DDTHH:MM
    const value = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    el.value = value;
  })();
</script>


<script>
  (function () {
    const dateEl = document.getElementById("deadline_date");
    const timeEl = document.getElementById("deadline_time4");
    const prettyEl = document.getElementById("deadline_time_pretty");
    if (!dateEl || !timeEl || !prettyEl) return;

    const pad2 = (n) => String(n).padStart(2, "0");
    const now = new Date();

    // –î–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è)
    if (!dateEl.value) {
      dateEl.value = `${now.getFullYear()}-${pad2(now.getMonth() + 1)}-${pad2(now.getDate())}`;
    }

    // –í—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ç–µ–∫—É—â–∏–π —á–∞—Å:–º–∏–Ω—É—Ç–∞ ‚Üí HHMM)
    if (!timeEl.value) {
      timeEl.value = `${pad2(now.getHours())}${pad2(now.getMinutes())}`;
    }

    function parseTime(value) {
      const digits = (value || "").replace(/\D/g, "").slice(0, 4);
      if (!digits) return null;

      let hh = 0;
      let mm = 0;

      if (digits.length <= 2) {
        // 9 -> 09:00, 12 -> 12:00
        hh = parseInt(digits, 10);
        mm = 0;
      } else {
        // 930 -> 09:30, 1234 -> 12:34
        const padded = digits.padStart(4, "0");
        hh = parseInt(padded.slice(0, 2), 10);
        mm = parseInt(padded.slice(2, 4), 10);
      }

      hh = Math.min(23, hh || 0);
      mm = Math.min(59, mm || 0);

      return { hh, mm };
    }

    function render() {
      const parsed = parseTime(timeEl.value);
      if (!parsed) {
        prettyEl.textContent = "--:--";
        return;
      }
      prettyEl.textContent = `${pad2(parsed.hh)}:${pad2(parsed.mm)}`;
    }

    timeEl.addEventListener("input", () => {
      timeEl.value = (timeEl.value || "").replace(/\D/g, "").slice(0, 4);
      render();
    });

    timeEl.addEventListener("blur", () => {
      const parsed = parseTime(timeEl.value);
      if (!parsed) return;
      timeEl.value = `${pad2(parsed.hh)}${pad2(parsed.mm)}`;
      render();
    });

    render();
  })();
</script>




</body>
</html>
