<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–ó–∞—è–≤–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .muted { color: #6c757d; }
    body {
      background: linear-gradient(180deg, #eef2f8 0%, #e8edf5 100%) !important;
      min-height: 100vh;
    }
    .panel-card {
      border: 1px solid #d7e2f4;
      border-radius: 14px;
      box-shadow: 0 .45rem 1rem rgba(27, 43, 65, .08);
      background: #f8fbff;
    }
    .panel-card .card-body {
      background: linear-gradient(180deg, #fafdff 0%, #f3f8ff 100%);
      border-radius: 14px;
    }
    .panel-title {
      font-size: 1rem;
      font-weight: 700;
      color: #24406c;
      margin-bottom: .75rem;
    }
    details.panel-toggle > summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: .75rem;
    }
    details.panel-toggle > summary::-webkit-details-marker { display: none; }
    .panel-chevron {
      color: #4c6b96;
      transition: transform .2s ease;
      font-size: .9rem;
    }
    details.panel-toggle[open] .panel-chevron { transform: rotate(180deg); }
    .form-label {
      font-weight: 600;
      color: #365175;
    }
    .form-control, .form-select {
      border-color: #cdd9eb;
      background: #fff;
    }
    .form-control:focus, .form-select:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 .2rem rgba(13,110,253,.15);
    }
    .ticket {
      border: 1px solid #dfe7f5;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
      background: #fff;
      box-shadow: 0 .35rem .9rem rgba(33, 37, 41, .05);
    }
    .ticket h5 { margin: 0 0 8px 0; }
    .badge-status { font-size: 12px; }
    .ticket.overdue { border-color: #dc3545; }
    .ticket.overdue .st-OVERDUE { background: #dc3545 !important; }
    .badge-status { font-weight: 600; }
    .badge-status {
      cursor: pointer;
      padding: 0.45rem 0.6rem;
    }
    .badge-status:hover { filter: brightness(0.95); }
    .badge-status:active { transform: translateY(1px); }
    .st-NEW { background: #6c757d !important; }          /* —Å–µ—Ä—ã–π */
    .st-IN_PROGRESS { background: #0d6efd !important; }  /* —Å–∏–Ω–∏–π */
    .st-DONE { background: #198754 !important; }         /* –∑–µ–ª—ë–Ω—ã–π */
    .st-CANCELED { background: #212529 !important; }     /* —Ç—ë–º–Ω—ã–π */
    .st-OVERDUE { background: #dc3545 !important; }      /* –∫—Ä–∞—Å–Ω—ã–π */
    .status-menu {
      position: absolute;
      top: 110%;
      right: 0;
      min-width: 160px;
      z-index: 10;

      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
    }

    .status-menu.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .dash-card { cursor: pointer; transition: transform .12s ease, box-shadow .12s ease; }
  .dash-card:hover { transform: translateY(-1px); }
  .dash-card:active { transform: translateY(0); }
  /* –¶–≤–µ—Ç–Ω—ã–µ —Ä–∞–º–∫–∏ + –ª—ë–≥–∫–∏–π —Ñ–æ–Ω (–≤–∑—è—Ç–æ –ø–æ —Å–º—ã—Å–ª—É –∏–∑ —Ü–≤–µ—Ç–æ–≤ –±–µ–π–¥–∂–µ–π) */
  .dash-NEW { border-left: 6px solid #6c757d; }
  .dash-IN_PROGRESS { border-left: 6px solid #0d6efd; }
  .dash-DONE { border-left: 6px solid #198754; }
  .dash-CANCELED { border-left: 6px solid #212529; }
  .dash-OVERDUE { border-left: 6px solid #dc3545; }
  .dashboard-card.active {
  outline: 3px solid rgba(13,110,253,.35);
  outline-offset: 2px;
}

    .comments-list { display: flex; flex-direction: column; gap: 8px; }
    .comment-row { display: flex; }
    .comment-row.theirs { justify-content: flex-start; }
    .comment-row.mine { justify-content: flex-end; }
    .comment-bubble {
      max-width: 85%;
      border-radius: 12px;
      padding: .5rem .65rem;
      border: 1px solid #e9ecef;
      background: #fff;
    }
    .comment-row.mine .comment-bubble {
      background: #e7f1ff;
      border-color: #b6d4fe;
    }

    .ticket-head {
      background: linear-gradient(135deg, #f8fbff 0%, #eef5ff 55%, #e7f1ff 100%);
      border: 1px solid #dce7fb;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 8px;
    }
    .ticket-head-id { font-size: 12px; color: #7b8aa3; margin-bottom: 4px; }
    .ticket-head-project { font-size: 13px; color: #476284; margin-bottom: 6px; }
    .ticket-head-title a { color: #0d3a8f; }
    .ticket-head-title a:hover { color: #0a2e72; }
    .ticket-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .meta-chip {
      background: #fff;
      border: 1px solid #dfe6f3;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      color: #495057;
    }
    .sub-card {
      background: #fbfcff;
      border: 1px solid #e8eef9;
      border-radius: 12px;
      padding: 12px;
    }

  </style>
  <input type="hidden" name="next" value="/web">
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-0">–ó–∞—è–≤–∫–∏</h3>
        <div class="muted">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <b>{{ user.name }}</b> ({{ user.role }})</div>
      </div>
      <div class="d-flex gap-2">
  {% if user.role == "CURATOR" %}
    <a class="btn btn-outline-secondary" href="/web/projects">–ü—Ä–æ–µ–∫—Ç—ã</a>
    <a class="btn btn-outline-secondary" href="/web/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
  {% endif %}
  <a class="btn btn-outline-secondary" href="/docs" target="_blank">Swagger</a>
  <a class="btn btn-outline-danger" href="/web/logout">–í—ã–π—Ç–∏</a>
</div>
    </div>
    {% if user.role in ["CURATOR", "EXECUTOR"] %}
    <div class="card shadow-sm mb-3 panel-card">
      <div class="card-body">
        <details class="panel-toggle">
          <summary class="panel-title mb-0">
            <span>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</span>
            <span class="panel-chevron">‚ñº</span>
          </summary>
          <form method="post" action="/web/tickets/create" class="row g-2 mt-1">
            <div class="col-12 col-md-6">
              <input name="title" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
            </div>
            <div class="col-12 col-md-6">
              <select name="project_id" class="form-select" required>
                <option value="" selected disabled>–ü—Ä–æ–µ–∫—Ç</option>
                {% for p in projects %}
                  <option value="{{ p.id }}">{{ p.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <textarea name="description" class="form-control" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
            </div>
            <div class="col-12 col-md-6">
              <div class="row g-2">
                <div class="col-12 col-md-6">
                  <label class="form-label mb-1">–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫: –¥–∞—Ç–∞</label>
                  <input id="deadline_date" name="deadline_date" type="date" class="form-control" />
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label mb-1">–í—Ä–µ–º—è (–≤–≤–µ–¥–∏—Ç–µ 4 —Ü–∏—Ñ—Ä—ã, HHMM)</label>
                  <div class="input-group">
                    <input id="deadline_time4" name="deadline_time4" class="form-control" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 0930 –∏–ª–∏ 1745" maxlength="4" />
                    <span class="input-group-text" id="deadline_time_pretty">--:--</span>
                  </div>
                  <div class="muted small mt-1">
                    –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å 1‚Äì4 —Ü–∏—Ñ—Ä—ã: <code>9</code> ‚Üí <code>09:00</code>, <code>930</code> ‚Üí <code>09:30</code>. –ü—É—Å—Ç–æ ‚Äî —Å—Ä–æ–∫ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
                  </div>
                </div>
              </div>

              <div class="col-12 muted small">
                –ï—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å ‚Äî —Å—Ä–æ–∫ –Ω–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
              </div>
            </div>
            <div class="col-12 col-md-6">
              {% if user.role == "CURATOR" %}
                <select name="executor_id" class="form-select">
                  <option value="" selected>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
                  {% for e in executors %}
                    <option value="{{ e.id }}">{{ e.name }} ({{ e.email }})</option>
                  {% endfor %}
                </select>
              {% else %}
                <input type="hidden" name="executor_id" value="" />
                <div class="form-control bg-light">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: –≤—ã —Å–∞–º–∏</div>
              {% endif %}
            </div>
            <div class="col-12">
              <button class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </form>

          <div class="mt-2 muted small">
            –ß—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤/–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –±—ã–ª –Ω–µ –ø—É—Å—Ç—ã–º ‚Äî —Å–æ–∑–¥–∞–π –ø—Ä–æ–µ–∫—Ç –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–º–æ–∂–Ω–æ –≤ Swagger).
          </div>
        </details>
      </div>
    </div>
    {% endif %}

    <div class="card shadow-sm mb-3 panel-card">
      <div class="card-body">
        <details class="panel-toggle">
          <summary class="panel-title mb-0">
            <span>–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</span>
            <span class="panel-chevron">‚ñº</span>
          </summary>
          <form method="get" action="/web" class="row g-2 align-items-end mt-1">
            <div class="col-12 col-md-4">
              <label class="form-label mb-1">–ü–æ–∏—Å–∫</label>
              <input name="q" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ..." value="{{ q }}" />
            </div>

            <div class="col-6 col-md-3">
              <label class="form-label mb-1">–°—Ç–∞—Ç—É—Å</label>
              <select name="status_filter" class="form-select">
                <option value="" {% if not status_filter %}selected{% endif %}>–í—Å–µ</option>
                <option value="NEW" {% if status_filter == "NEW" %}selected{% endif %}>NEW</option>
                <option value="IN_PROGRESS" {% if status_filter == "IN_PROGRESS" %}selected{% endif %}>IN_PROGRESS</option>
                <option value="DONE" {% if status_filter == "DONE" %}selected{% endif %}>DONE</option>
                <option value="CANCELED" {% if status_filter == "CANCELED" %}selected{% endif %}>CANCELED</option>
              </select>
            </div>

            <div class="col-6 col-md-3">
              <label class="form-label mb-1">–ü—Ä–æ–µ–∫—Ç</label>
              <select name="project_id" class="form-select">
                <option value="" {% if not project_id_filter %}selected{% endif %}>–í—Å–µ</option>
                {% for p in projects %}
                  <option value="{{ p.id }}" {% if project_id_filter == p.id %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-2 d-flex gap-2">
              <button class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>

            {% if user.role == "CURATOR" %}
              <div class="col-6 col-md-3">
                <label class="form-label mb-1">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                <select name="executor_id" class="form-select">
                  <option value="" {% if not executor_id_filter %}selected{% endif %}>–í—Å–µ</option>
                  <option value="__none__" {% if executor_id_filter == "__none__" %}selected{% endif %}>‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ ‚Äî</option>
                  {% for e in executors %}
                    <option value="{{ e.id }}" {% if executor_id_filter == e.id %}selected{% endif %}>{{ e.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-12 col-md-3">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="only_overdue" name="only_overdue" value="1"
                         {% if only_overdue == "1" %}checked{% endif %}>
                  <label class="form-check-label" for="only_overdue">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</label>
                </div>
              </div>
            {% endif %}

            <div class="col-12">
              <div class="col-6 col-md-3">
                <label class="form-label mb-1">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                <select name="sort" class="form-select">
                  <option value="id_desc" {% if sort == "id_desc" %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                  <option value="id_asc" {% if sort == "id_asc" %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                  <option value="deadline_asc" {% if sort == "deadline_asc" %}selected{% endif %}>–°—Ä–æ–∫: –±–ª–∏–∂–∞–π—à–∏–µ</option>
                  <option value="deadline_desc" {% if sort == "deadline_desc" %}selected{% endif %}>–°—Ä–æ–∫: –¥–∞–ª—å–Ω–∏–µ</option>
                  <option value="status" {% if sort == "status" %}selected{% endif %}>–ü–æ —Å—Ç–∞—Ç—É—Å—É</option>
                </select>
              </div>

              <a class="small" href="/web">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
            </div>
          </form>
        </details>
      </div>
    </div>

    <div class="row g-2 mb-3">

  <!--–î–ê–®–ë–û–ê–†–î -- –í–°–ï -->
  <div class="row g-2 mb-3" id="dashboard"
     data-status-filter="{{ status_filter }}"
     data-only-overdue="{{ only_overdue }}"
     data-project-id="{{ project_id_filter }}"
     data-executor-id="{{ executor_id_filter }}"
     data-q="{{ q }}"
     data-sort="{{ sort }}">

  <div class="col-6 col-lg-2">
    <div class="card shadow-sm dash-card dashboard-card" data-dash="all">
      <div class="card-body py-2">
        <div class="small muted">–í—Å–µ–≥–æ</div>
        <div class="fs-5 fw-semibold">{{ total_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-6 col-lg-2">
    <div class="card shadow-sm dash-card dash-OVERDUE dashboard-card" data-dash="overdue">
      <div class="card-body py-2">
        <div class="small muted">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
        <div class="fs-5 fw-semibold">{{ overdue_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-6 col-lg-2">
    <div class="card shadow-sm dash-card dash-NEW dashboard-card" data-dash="status" data-status="NEW">
      <div class="card-body py-2">
        <div class="small muted">–ù–æ–≤—ã–µ</div>
        <div class="fs-5 fw-semibold">{{ counts_by_status["NEW"] }}</div>
      </div>
    </div>
  </div>

  <div class="col-6 col-lg-2">
    <div class="card shadow-sm dash-card dash-IN_PROGRESS dashboard-card" data-dash="status" data-status="IN_PROGRESS">
      <div class="card-body py-2">
        <div class="small muted">–í —Ä–∞–±–æ—Ç–µ</div>
        <div class="fs-5 fw-semibold">{{ counts_by_status["IN_PROGRESS"] }}</div>
      </div>
    </div>
  </div>

  <div class="col-6 col-lg-2">
    <div class="card shadow-sm dash-card dash-DONE dashboard-card" data-dash="status" data-status="DONE">
      <div class="card-body py-2">
        <div class="small muted">–í—ã–ø–æ–ª–Ω–µ–Ω—ã</div>
        <div class="fs-5 fw-semibold">{{ counts_by_status["DONE"] }}</div>
      </div>
    </div>
  </div>

  <div class="col-6 col-lg-2">
    <div class="card shadow-sm dash-card dash-CANCELED dashboard-card" data-dash="status" data-status="CANCELED">
      <div class="card-body py-2">
        <div class="small muted">–û—Ç–º–µ–Ω–µ–Ω—ã</div>
        <div class="fs-5 fw-semibold">{{ counts_by_status["CANCELED"] }}</div>
      </div>
    </div>
  </div>
</div>


</div>



    {% for t in tickets %}
      <div id="ticket-{{ t.id }}" class="ticket shadow-sm {% if t.deadline and t.status != 'DONE' and t.status != 'CANCELED' and t.deadline < now %}overdue{% endif %}">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div style="flex:1">
            <div class="ticket-head">
              <div class="ticket-head-id">ID –∑–∞—è–≤–∫–∏: #{{ t.id }}</div>
              <div class="ticket-head-project">–ü—Ä–æ–µ–∫—Ç: <b>{{ projects_by_id.get(t.project_id, "‚Äî") }}</b></div>
              <h5 class="ticket-head-title">
                <a href="/web/tickets/{{ t.id }}" class="text-decoration-none">
                  {{ t.title }}
                </a>
              </h5>

              <div class="muted mb-2">{{ t.description or "" }}</div>
              <div class="ticket-meta">
                <span class="meta-chip">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: <b>{{ users_by_id.get(t.executor_id, "‚Äî") }}</b></span>
                <span class="meta-chip">–°—Ä–æ–∫: <b>{{ format_dt(t.deadline) }}</b></span>
                <span class="meta-chip">–°–æ–∑–¥–∞–ª: <b>{{ users_by_id.get(t.created_by, "‚Äî") }}</b></span>
              </div>
            </div>
          </div>

          <div class="text-end">
            {% set is_overdue = t.deadline and t.status != "DONE" and t.status != "CANCELED" and t.deadline < now %}

<div class="d-flex justify-content-between align-items-center gap-2">
  <div class="d-flex flex-wrap gap-2 align-items-center">
    {% if is_overdue %}
      <span id="overdue-badge-{{ t.id }}" class="badge badge-status st-OVERDUE"
      style="{% if not is_overdue %}display:none;{% endif %}">
  –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
</span>


    {% endif %}
  </div>

  <div class="position-relative d-inline-block">
  
  <!-- –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å -->
  <span id="status-badge-{{ t.id }}" class="badge badge-status st-{{ t.status.value }} status-toggle" data-ticket-id="{{ t.id }}">
  {{ status_labels[t.status.value] }} ‚ñº
</span>


  <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é -->
  <div id="status-menu-{{ t.id }}" class="status-menu shadow-sm p-2 bg-white rounded">
  <button type="button" class="badge badge-status st-NEW w-100 mb-1 border-0 status-option" data-ticket-id="{{ t.id }}" data-status="NEW">–ù–æ–≤–∞—è</button>
  <button type="button" class="badge badge-status st-IN_PROGRESS w-100 mb-1 border-0 status-option" data-ticket-id="{{ t.id }}" data-status="IN_PROGRESS">–í —Ä–∞–±–æ—Ç–µ</button>
  <button type="button" class="badge badge-status st-DONE w-100 mb-1 border-0 status-option" data-ticket-id="{{ t.id }}" data-status="DONE">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</button>
  <button type="button" class="badge badge-status st-CANCELED w-100 border-0 status-option" data-ticket-id="{{ t.id }}" data-status="CANCELED">–û—Ç–º–µ–Ω–µ–Ω–∞</button>
</div>


</div>

</div>

            {% if user.role == "CURATOR" or (user.role == "EXECUTOR" and (t.executor_id == user.id or t.created_by == user.id)) %}
  <a class="btn btn-sm btn-outline-secondary w-100 mt-2" href="/web/tickets/{{ t.id }}/edit?next=/web">–ò–∑–º–µ–Ω–∏—Ç—å</a>
{% endif %}

            {% if user.role == "CURATOR" or (user.role == "EXECUTOR" and t.created_by == user.id) %}
            <form method="post" action="/web/tickets/{{ t.id }}/delete" class="mt-2"
              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É #{{ t.id }}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');">
            <input type="hidden" name="next" value="/web">
              <button class="btn btn-sm btn-outline-danger w-100">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
            {% endif %}

          </div>
        </div>

        <hr />

        <div class="row g-3">
          <div class="col-12 col-lg-7">
            <h6>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h6>
            <div class="mb-2 comments-list sub-card">
              {% set recent_comments = comments_by_ticket.get(t.id, [])[-2:] %}
              {% for c in recent_comments %}
                {% set is_mine = c.author_id == user.id %}
                <div class="comment-row {% if is_mine %}mine{% else %}theirs{% endif %}">
                  <div class="comment-bubble">
                    <div class="small muted">
                      <b>{{ users_by_id.get(c.author_id, "‚Äî") }}</b> ¬∑ {{ format_dt(c.created_at) }}
                    </div>
                    <div>{{ c.text }}</div>
                  </div>
                </div>
              {% endfor %}
              {% if recent_comments|length == 0 %}
                <div class="muted small">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
              {% endif %}
            </div>

            <form method="post" action="/web/tickets/{{ t.id }}/comments" class="d-flex gap-2">
              <input name="text" class="form-control" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required />
              <button class="btn btn-outline-secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
          </div>

          <!-- <div class="col-12 col-lg-5">
            <h6>–§–∞–π–ª—ã</h6>
            <div class="mb-2">
              {% for a in attachments_by_ticket.get(t.id, []) %}
                <div class="small">
                  üìé {{ a.file_path }}
                </div>
              {% endfor %}
              {% if attachments_by_ticket.get(t.id, [])|length == 0 %}
                <div class="muted small">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</div>
              {% endif %}
            </div>

            <form method="post" action="/web/tickets/{{ t.id }}/attachments" enctype="multipart/form-data" class="d-flex gap-2">
              <input type="file" name="file" class="form-control" required />
              <button class="btn btn-outline-secondary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </form>
          </div> -->
        </div>
      </div>
    {% endfor %}

    {% if tickets|length == 0 %}
      <div class="alert alert-info">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
    {% endif %}
  </div>

<script>
  (function () {
    const el = document.getElementById("deadline_dt");
    if (!el || el.value) return;

    const d = new Date();
    const pad2 = (n) => String(n).padStart(2, "0");

    // datetime-local –æ–∂–∏–¥–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç: YYYY-MM-DDTHH:MM
    const value = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    el.value = value;
  })();
</script>


<script>
  (function () {
    const dateEl = document.getElementById("deadline_date");
    const timeEl = document.getElementById("deadline_time4");
    const prettyEl = document.getElementById("deadline_time_pretty");
    if (!dateEl || !timeEl || !prettyEl) return;

    const pad2 = (n) => String(n).padStart(2, "0");
    const now = new Date();

    // –î–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è)
    if (!dateEl.value) {
      dateEl.value = `${now.getFullYear()}-${pad2(now.getMonth() + 1)}-${pad2(now.getDate())}`;
    }

    // –í—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ç–µ–∫—É—â–∏–π —á–∞—Å:–º–∏–Ω—É—Ç–∞ ‚Üí HHMM)
    if (!timeEl.value) {
      timeEl.value = `${pad2(now.getHours())}${pad2(now.getMinutes())}`;
    }

    function parseTime(value) {
      const digits = (value || "").replace(/\D/g, "").slice(0, 4);
      if (!digits) return null;

      let hh = 0;
      let mm = 0;

      if (digits.length <= 2) {
        // 9 -> 09:00, 12 -> 12:00
        hh = parseInt(digits, 10);
        mm = 0;
      } else {
        // 930 -> 09:30, 1234 -> 12:34
        const padded = digits.padStart(4, "0");
        hh = parseInt(padded.slice(0, 2), 10);
        mm = parseInt(padded.slice(2, 4), 10);
      }

      hh = Math.min(23, hh || 0);
      mm = Math.min(59, mm || 0);

      return { hh, mm };
    }

    function render() {
      const parsed = parseTime(timeEl.value);
      if (!parsed) {
        prettyEl.textContent = "--:--";
        return;
      }
      prettyEl.textContent = `${pad2(parsed.hh)}:${pad2(parsed.mm)}`;
    }

    timeEl.addEventListener("input", () => {
      timeEl.value = (timeEl.value || "").replace(/\D/g, "").slice(0, 4);
      render();
    });

    timeEl.addEventListener("blur", () => {
      const parsed = parseTime(timeEl.value);
      if (!parsed) return;
      timeEl.value = `${pad2(parsed.hh)}${pad2(parsed.mm)}`;
      render();
    });

    render();
  })();
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  function closeAllMenus(exceptId) {
    document.querySelectorAll(".status-menu").forEach(m => {
      if (!exceptId || m.id !== exceptId) m.classList.remove("show");
    });
  }

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ –∫–ª–∏–∫—É –Ω–∞ –±–µ–π–¥–∂
  document.querySelectorAll(".status-toggle").forEach(function (el) {
    el.addEventListener("click", function (event) {
      event.stopPropagation();
      const ticketId = el.dataset.ticketId;
      const menuId = "status-menu-" + ticketId;
      const menu = document.getElementById(menuId);
      if (!menu) return;

      closeAllMenus(menuId);
      menu.classList.toggle("show");
    });
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
  document.addEventListener("click", function () {
    closeAllMenus(null);
  });

  // AJAX —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
  async function setStatus(ticketId, status) {
    const fd = new FormData();
    fd.append("status", status);

    const res = await fetch(`/web/tickets/${ticketId}/status`, {
      method: "POST",
      body: fd,
      headers: { "Accept": "application/json" },
      credentials: "same-origin"
    });

    if (!res.ok) {
      const text = await res.text();
      alert("–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞: " + text);
      return;
    }

    const data = await res.json();
    if (!data.ok) return;
    const STATUS_LABELS = {
  NEW: "–ù–æ–≤–∞—è",
  IN_PROGRESS: "–í —Ä–∞–±–æ—Ç–µ",
  DONE: "–í—ã–ø–æ–ª–Ω–µ–Ω–∞",
  CANCELED: "–û—Ç–º–µ–Ω–µ–Ω–∞",
};
    // 1) –æ–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞
    const badge = document.getElementById("status-badge-" + ticketId);
    if (badge) {
      

      // —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã st-*
      badge.className = badge.className.replace(/\bst-[A-Z_]+\b/g, "").trim();
      badge.classList.add("st-" + data.status);
      badge.textContent = (STATUS_LABELS[data.status] || data.status) + " ‚ñº";
    }

    // 2) overdue –±–µ–π–¥–∂ + –∫–ª–∞—Å—Å –∫–∞—Ä—Ç–æ—á–∫–∏
    const overdueBadge = document.getElementById("overdue-badge-" + ticketId);
    const ticketEl = document.getElementById("ticket-" + ticketId);

    if (overdueBadge) overdueBadge.style.display = data.is_overdue ? "" : "none";
    if (ticketEl) {
      if (data.is_overdue) ticketEl.classList.add("overdue");
      else ticketEl.classList.remove("overdue");
    }

    // 3) –∑–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é
    closeAllMenus(null);
  }

  document.querySelectorAll(".status-option").forEach(btn => {
    btn.addEventListener("click", function (event) {
      event.stopPropagation();
      const ticketId = btn.dataset.ticketId;
      const status = btn.dataset.status;
      setStatus(ticketId, status);
    });
  });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const dash = document.getElementById("dashboard");
  if (!dash) return;

  function getState() {
    return {
      status_filter: dash.dataset.statusFilter || "",
      only_overdue: dash.dataset.onlyOverdue || "",
      project_id: dash.dataset.projectId || "",
      executor_id: dash.dataset.executorId || "",
      q: dash.dataset.q || "",
      sort: dash.dataset.sort || "id_desc",
    };
  }

  function buildUrl(next) {
    const p = new URLSearchParams();
    p.set("status_filter", next.status_filter || "");
    p.set("project_id", next.project_id || "");
    p.set("executor_id", next.executor_id || "");
    p.set("q", next.q || "");
    p.set("only_overdue", next.only_overdue || "");
    p.set("sort", next.sort || "id_desc");
    return "/web?" + p.toString();
  }

  function applyActiveClasses() {
    const s = getState();
    document.querySelectorAll(".dashboard-card").forEach(card => {
      card.classList.remove("active");

      const type = card.dataset.dash;

      if (type === "overdue" && s.only_overdue === "1") card.classList.add("active");
      if (type === "status" && (card.dataset.status || "") === (s.status_filter || "")) card.classList.add("active");
      if (type === "all" && !s.only_overdue && !s.status_filter) card.classList.add("active");
    });
  }

  applyActiveClasses();

  document.querySelectorAll(".dashboard-card").forEach(card => {
    card.addEventListener("click", function () {
      const s = getState();
      const type = card.dataset.dash;

      const next = { ...s };

      if (type === "all") {
        next.status_filter = "";
        next.only_overdue = "";
      } else if (type === "overdue") {
        next.only_overdue = (s.only_overdue === "1") ? "" : "1";
      } else if (type === "status") {
        const target = card.dataset.status || "";
        next.status_filter = (s.status_filter === target) ? "" : target;
      }

      window.location.href = buildUrl(next);
    });
  });
});
</script>



  applyActiveClasses();

  document.querySelectorAll(".dashboard-card").forEach(card => {
    card.addEventListener("click", function () {
      const s = getState();
      const type = card.dataset.dash;

      // –∫–æ–ø–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
      const next = { ...s };

      if (type === "all") {
        // —Å–±—Ä–æ—Å status –∏ overdue, –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        next.status_filter = "";
        next.only_overdue = "";
      }

      if (type === "overdue") {
        // toggle overdue
        next.only_overdue = (s.only_overdue === "1") ? "" : "1";
        // –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–∞–∫ –µ—Å—Ç—å (–∏–ª–∏ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å) ‚Äî —è –æ—Å—Ç–∞–≤–∏–ª —Å—Ç–∞—Ç—É—Å
      }

      if (type === "status") {
        const target = card.dataset.status || "";
        // toggle status
        next.status_filter = (s.status_filter === target) ? "" : target;
        // overdue –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
      }

      window.location.href = buildUrl(next);
    });
  });
});
</script>




</body>
</html>
